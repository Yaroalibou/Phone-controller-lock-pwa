<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Phone Lock Client</title>
    <meta name="description" content="Remote phone lock client - Install as app for remote control">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- Favicon -->
    <link rel="icon" href="icons/icon-96x96.png" type="image/png">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lock Client">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    
    <!-- Android Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <style>
        /* Lock Screen Styles */
        #lockScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            z-index: 10000;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .lock-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .lock-icon {
            font-size: 100px;
            color: #ff4757;
            margin-bottom: 30px;
            animation: lockPulse 2s infinite;
        }
        
        @keyframes lockPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .lock-time {
            font-size: 60px;
            font-weight: 200;
            margin: 20px 0;
            letter-spacing: 2px;
        }
        
        .lock-date {
            font-size: 20px;
            opacity: 0.8;
            margin-bottom: 40px;
        }
        
        .lock-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            margin: 20px auto;
            backdrop-filter: blur(10px);
        }
        
        .lock-instruction {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .emergency-button {
            position: absolute;
            bottom: 30px;
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.5);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Install Banner */
        #installBanner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 15px;
            z-index: 9999;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .install-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .install-icon {
            font-size: 30px;
        }
        
        .install-text {
            flex: 1;
        }
        
        .install-text h3 {
            margin: 0 0 5px 0;
            color: white;
        }
        
        .install-text p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .install-actions {
            display: flex;
            gap: 10px;
        }
        
        /* App Badge */
        .app-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #2ecc71;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }
    </style>
</head>
<body>
    <!-- Lock Screen Overlay -->
    <div id="lockScreen">
        <div class="lock-container">
            <div class="lock-icon">
                <i class="fas fa-lock"></i>
            </div>
            
            <div class="lock-time" id="currentTime">--:--</div>
            <div class="lock-date" id="currentDate">--- --- --, ----</div>
            
            <div class="lock-message">
                <h1>PHONE LOCKED</h1>
                <p>This phone has been locked remotely</p>
                <p><i class="fas fa-mobile-alt"></i> Waiting for unlock command...</p>
            </div>
            
            <div class="lock-instruction">
                <i class="fas fa-info-circle"></i> To unlock, use the controller device
            </div>
            
            <div class="session-info-lock">
                Session: <span id="lockSessionId">Loading...</span>
            </div>
            
            <button class="emergency-button" onclick="emergencyUnlock()">
                <i class="fas fa-exclamation-triangle"></i> Emergency Exit
            </button>
        </div>
    </div>

    <!-- Install Banner -->
    <div id="installBanner">
        <div class="install-content">
            <div class="install-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="install-text">
                <h3>Install Phone Lock Client</h3>
                <p>Install as app for better experience</p>
            </div>
            <div class="install-actions">
                <button onclick="dismissInstall()" class="btn-small btn-secondary">Later</button>
                <button onclick="installApp()" class="btn-small btn-primary">Install</button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="container">
        <!-- App Badge -->
        <div class="app-badge" id="appBadge" style="display: none;">
            <i class="fas fa-check-circle"></i> Installed
        </div>

        <!-- Header -->
        <div class="header client-header">
            <div class="app-icon">
                <i class="fas fa-mobile-alt fa-3x"></i>
            </div>
            <h1>Phone Lock Client</h1>
            <p class="subtitle">Ready for remote control</p>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-signal"></i> Connection Status</h2>
            </div>
            
            <div class="status-display">
                <div class="status-item">
                    <span class="status-label">Firebase:</span>
                    <span class="status-value" id="firebaseStatus">
                        <span class="status-dot connecting"></span>
                        Connecting...
                    </span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Session:</span>
                    <span class="status-value" id="sessionStatus">
                        <span class="status-dot disconnected"></span>
                        Disconnected
                    </span>
                </div>
                
                <div class="status-item">
                    <span class="status-label">Lock State:</span>
                    <span class="status-value" id="lockStatusDisplay">
                        <span class="status-dot unlocked"></span>
                        <span class="lock-state-text">Unlocked</span>
                    </span>
                </div>
            </div>
            
            <div class="session-info-client">
                <div class="info-group">
                    <label><i class="fas fa-fingerprint"></i> Current Session:</label>
                    <div class="code-box" id="currentSessionId">No session connected</div>
                </div>
                
                <div class="connection-actions">
                    <button onclick="connectToSession()" class="btn-primary" id="connectBtn">
                        <i class="fas fa-plug"></i> Connect to Session
                    </button>
                    <button onclick="disconnectSession()" class="btn-danger" id="disconnectBtn" disabled>
                        <i class="fas fa-unlink"></i> Disconnect
                    </button>
                </div>
            </div>
        </div>

        <!-- Session Connect -->
        <div class="card" id="sessionConnectCard">
            <div class="card-header">
                <h2><i class="fas fa-link"></i> Connect to Session</h2>
            </div>
            
            <div class="connect-options">
                <div class="option">
                    <h3><i class="fas fa-qrcode"></i> Scan QR Code</h3>
                    <p>Use your camera to scan a QR code from the controller</p>
                    <button onclick="scanQRCode()" class="btn-secondary">
                        <i class="fas fa-camera"></i> Scan QR Code
                    </button>
                </div>
                
                <div class="option">
                    <h3><i class="fas fa-keyboard"></i> Enter Session ID</h3>
                    <p>Manually enter the session ID from the controller</p>
                    <div class="input-group">
                        <input type="text" id="sessionIdInput" placeholder="Enter session ID">
                        <button onclick="connectWithId()" class="btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Connect
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Info -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-info-circle"></i> Client Information</h2>
            </div>
            
            <div class="client-details">
                <div class="detail-item">
                    <i class="fas fa-id-badge"></i>
                    <div>
                        <strong>Client ID:</strong>
                        <span id="clientId">Generating...</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <strong>Uptime:</strong>
                        <span id="uptime">00:00:00</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-bell"></i>
                    <div>
                        <strong>Notifications:</strong>
                        <span id="notificationStatus">Checking...</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-battery-full"></i>
                    <div>
                        <strong>Battery:</strong>
                        <span id="batteryStatus">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Features -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-flask"></i> Test Features</h2>
            </div>
            
            <div class="test-buttons">
                <button onclick="testLockScreen()" class="btn-test">
                    <i class="fas fa-lock"></i> Test Lock Screen
                </button>
                <button onclick="testVibration()" class="btn-test">
                    <i class="fas fa-vibrate"></i> Test Vibration
                </button>
                <button onclick="testNotification()" class="btn-test">
                    <i class="fas fa-bell"></i> Test Notification
                </button>
                <button onclick="testSound()" class="btn-test">
                    <i class="fas fa-volume-up"></i> Test Sound
                </button>
            </div>
            
            <div class="permission-requests">
                <button onclick="requestNotificationPermission()" class="btn-small">
                    <i class="fas fa-bell"></i> Enable Notifications
                </button>
                <button onclick="requestVibrationPermission()" class="btn-small">
                    <i class="fas fa-vibrate"></i> Enable Vibration
                </button>
            </div>
        </div>

        <!-- Command Log -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-list-alt"></i> Command Log</h2>
                <button onclick="clearCommandLog()" class="btn-small">Clear</button>
            </div>
            
            <div class="log-container">
                <div id="commandLog">
                    <div class="log-entry info">
                        <span class="log-time">[System]</span>
                        <span class="log-text">Client initialized. Ready to connect.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions-card">
            <h3><i class="fas fa-info-circle"></i> How It Works</h3>
            <ol>
                <li><strong>Install this app</strong> on your target phone</li>
                <li><strong>Connect</strong> to a session from the controller</li>
                <li><strong>Keep app running</strong> in background</li>
                <li><strong>Controller can remotely</strong> lock/unlock your phone</li>
                <li><strong>Emergency exit</strong> available if needed</li>
            </ol>
            
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i>
                <p>For safety, keep your controller device secure. Only share session links with trusted devices.</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Phone Lock Client • v2.0</p>
            <p class="small-text">Keep app open for remote control</p>
            <div class="app-info">
                <span id="appMode">Web Mode</span>
                •
                <span id="connectionCount">0 connections</span>
            </div>
        </div>
    </div>

    <!-- Camera Modal for QR Scanning -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Scan QR Code</h3>
                <button onclick="closeCamera()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cameraContainer">
                    <video id="cameraPreview" autoplay playsinline></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                </div>
                <div class="camera-instructions">
                    <p>Point camera at QR code from controller</p>
                    <p id="cameraStatus">Initializing camera...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeCamera()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="client.js"></script>
    
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                        
                        // Check if app is installed
                        if (window.matchMedia('(display-mode: standalone)').matches) {
                            document.getElementById('appBadge').style.display = 'block';
                            document.getElementById('appMode').textContent = 'App Mode';
                        }
                        
                        // Listen for controller messages
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data && event.data.type === 'LOCK_COMMAND') {
                                handleLockCommand(event.data.command);
                            }
                        });
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // Check for install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner after 3 seconds
            setTimeout(showInstallBanner, 3000);
        });

        // Update lock screen time
        function updateLockScreenTime() {
            const now = new Date();
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString([], {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'});
            }
        }

        // Show install banner
        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (banner && deferredPrompt) {
                banner.style.display = 'block';
            }
        }

        // Install app
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted install');
                    document.getElementById('installBanner').style.display = 'none';
                }
                
                deferredPrompt = null;
            }
        }

        // Dismiss install banner
        function dismissInstall() {
            document.getElementById('installBanner').style.display = 'none';
        }

        // Update lock screen time every second
        setInterval(updateLockScreenTime, 1000);
        
        // Initial call
        updateLockScreenTime();
    </script>
</body>
</html>
